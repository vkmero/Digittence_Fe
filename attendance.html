<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance | Digittence</title>
<link rel="stylesheet" href="style.css">
</head>

<body onload="checkAuth(); initAttendance()">

<div class="overlay"></div>

<nav class="navbar">
    <h2>Mark Attendance</h2>
    <button class="nav-btn" onclick="logout()">Logout</button>
</nav>

<section class="features">

<div class="control-card">

    <input type="date" id="date" required>
    <input type="number" id="hours" placeholder="Hours" required>

    <select id="subjectSelect"></select>

    <button class="btn btn-secondary" onclick="openSubjectModal()">+ Subject</button>
    <button class="btn btn-primary" onclick="openStudentModal()">+ Student</button>

</div>

<table>
<thead>
<tr>
    <th>Name</th>
    <th>Roll No</th>
    <th>Status</th>
    <th>Actions</th>
</tr>
</thead>
<tbody id="studentsTable"></tbody>
</table>

<br>

<button class="add-student-main" onclick="openStudentModal()">+ Add Student</button>
<button class="btn-primary" onclick="saveAttendance()">Save Attendance</button>

</section>

<div class="modal" id="subjectModal">
    <div class="modal-content">
        <h3>Add Subject</h3>
        <input type="text" id="newSubjectName" placeholder="Subject Name">
        <button class="btn btn-primary" onclick="addSubject()">Add</button>
        <button class="btn btn-danger" onclick="closeSubjectModal()">Cancel</button>
    </div>
</div>

<div class="modal" id="studentModal">
    <div class="modal-content">
        <h3>Add Student</h3>
        <input type="text" id="newStudentName" placeholder="Name">
        <input type="text" id="newStudentRoll" placeholder="Roll No">
        <button class="btn btn-primary" onclick="addStudent()">Add</button>
        <button class="btn btn-danger" onclick="closeStudentModal()">Cancel</button>
    </div>
</div>

<script src="script.js"></script>

<script>
let students = [];
let editingStudentId = null;

function getClassId() {
    const id = localStorage.getItem("selectedClass");
    if (!id) window.location.href = "classes.html";
    return id;
}

async function initAttendance() {
    const classId = getClassId();
    document.getElementById("date").valueAsDate = new Date();
    await loadSubjectsDropdown(classId);
    await loadStudentsTable(classId);
}

async function loadSubjectsDropdown(classId) {
    const subjects = await fetchAPI(`http://localhost:5000/api/subjects/${classId}`);
    const select = document.getElementById("subjectSelect");
    select.innerHTML = "";

    subjects.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        select.appendChild(opt);
    });
}

async function loadStudentsTable(classId) {
    students = await fetchAPI(`http://localhost:5000/api/students/${classId}`);
    const tbody = document.getElementById("studentsTable");
    tbody.innerHTML = "";

    students.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.name}</td>
            <td>${s.rollNo}</td>
            <td>
                <button id="p-${s._id}" class="attendance-btn inactive"
                    onclick="setStatus('${s._id}','P')">P</button>

                <button id="a-${s._id}" class="attendance-btn inactive"
                    onclick="setStatus('${s._id}','A')">A</button>
            </td>
            <td>
                <button class="action-btn edit-btn"
                    onclick="openEditStudent('${s._id}','${s.name}','${s.rollNo}')">Edit</button>

                <button class="action-btn delete-btn"
                    onclick="deleteStudentRow('${s._id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function setStatus(studentId, status) {
    const student = students.find(s => String(s._id) === String(studentId));
    if (!student) return;

    student.status = status;

    const pBtn = document.getElementById(`p-${studentId}`);
    const aBtn = document.getElementById(`a-${studentId}`);
    if (!pBtn || !aBtn) return;

    pBtn.classList.remove("present", "absent", "inactive");
    aBtn.classList.remove("present", "absent", "inactive");

    if (status === "P") {
        pBtn.classList.add("present");
        aBtn.classList.add("inactive");
    } else {
        aBtn.classList.add("absent");
        pBtn.classList.add("inactive");
    }
}

function openSubjectModal() {
    document.getElementById("newSubjectName").value = "";
    document.getElementById("subjectModal").style.display = "flex";
}

function closeSubjectModal() {
    document.getElementById("subjectModal").style.display = "none";
}

async function addSubject() {
    const name = document.getElementById("newSubjectName").value.trim();
    if (!name) return;

    await fetchAPI("http://localhost:5000/api/subjects", "POST", {
        name,
        class: getClassId()
    });

    closeSubjectModal();
    await loadSubjectsDropdown(getClassId());
}


function openStudentModal() {
    editingStudentId = null;
    document.getElementById("newStudentName").value = "";
    document.getElementById("newStudentRoll").value = "";
    document.getElementById("studentModal").style.display = "flex";
}

function openEditStudent(id, name, rollNo) {
    editingStudentId = id;
    document.getElementById("newStudentName").value = name;
    document.getElementById("newStudentRoll").value = rollNo;
    document.getElementById("studentModal").style.display = "flex";
}

function closeStudentModal() {
    document.getElementById("studentModal").style.display = "none";
}

async function addStudent() {
    const name = document.getElementById("newStudentName").value.trim();
    const rollNo = document.getElementById("newStudentRoll").value.trim();

    if (!name || !rollNo) return;

    if (editingStudentId) {
        await fetchAPI(`http://localhost:5000/api/students/${editingStudentId}`, "PUT", {
            name,
            rollNo
        });
    } else {
        await fetchAPI("http://localhost:5000/api/students", "POST", {
            name,
            rollNo,
            class: getClassId()
        });
    }

    closeStudentModal();
    await loadStudentsTable(getClassId());
}

async function deleteStudentRow(id) {
    if (!confirm("Delete student?")) return;
    await fetchAPI(`http://localhost:5000/api/students/${id}`, "DELETE");
    await loadStudentsTable(getClassId());
}


async function saveAttendance() {
    const classId = getClassId();
    const subject = document.getElementById("subjectSelect").value;
    const date = document.getElementById("date").value;
    const hours = Number(document.getElementById("hours").value);

    if (!subject || !date || !hours) {
        alert("Please fill all fields.");
        return;
    }

    const records = students.map(s => ({
        student: s._id,
        status: s.status || "A"
    }));

    await fetchAPI("http://localhost:5000/api/attendance", "POST", {
        class: classId,
        subject,
        date,
        hours,
        records
    });

    alert("Attendance Saved Successfully!");
}
</script>

</body>
</html>