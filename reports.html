<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reports | Digittence</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body onload="checkAuth(); initReports()">

<div class="overlay"></div>

<nav class="navbar">
    <h2>Reports</h2>
    <button class="nav-btn" onclick="logout()">Logout</button>
</nav>

<section class="features">
    <h2>Generate Attendance Report</h2>

    <div class="control-card">

        <select id="reportSubject" required></select>

        <input type="date" id="startDate" required>
        <input type="date" id="endDate" required>

        <button class="btn btn-primary" onclick="generateReport()">
            Generate Excel
        </button>

    </div>

</section>

<script src="script.js"></script>

<script>

function getClassId() {
    const classId = localStorage.getItem('selectedClass');
    if (!classId) {
        alert("No class selected.");
        window.location.href = "classes.html";
    }
    return classId;
}

async function initReports() {
    await loadSubjects();
}

async function loadSubjects() {
    const classId = getClassId();

    const subjects = await fetchAPI(
        `http://localhost:5000/api/subjects/${classId}`
    );

    const select = document.getElementById("reportSubject");
    select.innerHTML = "";

    subjects.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        select.appendChild(opt);
    });
}

async function generateReport() {
    try {
        const classId = getClassId();
        const subject = document.getElementById('reportSubject').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const token = localStorage.getItem('token');

        const res = await fetch('http://localhost:5000/api/report', {
            method: 'POST',
            headers: {
                'Content-Type':'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ classId, subject, start, end })
        });

        if(!res.ok) {
            const err = await res.json();
            throw new Error(err.message || "Failed to generate report");
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'attendance_report.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();

    } catch(err) {
        alert(err.message);
    }
}

</script>

</body>
</html>